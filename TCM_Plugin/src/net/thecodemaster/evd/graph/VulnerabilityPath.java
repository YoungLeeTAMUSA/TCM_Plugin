package net.thecodemaster.evd.graph;

import java.util.List;

import net.thecodemaster.evd.helper.Creator;
import net.thecodemaster.evd.logger.PluginLogger;

import org.eclipse.jdt.core.dom.Expression;
import org.eclipse.jdt.core.dom.Statement;

/**
 * @author Luciano Sampaio
 */
public class VulnerabilityPath {

	private final Expression							root;
	private VulnerabilityPath							parent;
	private final List<VulnerabilityPath>	childrenPaths;
	private boolean												foundVulnerability;
	private String												message;

	public VulnerabilityPath(Expression root) {
		this.root = root;
		childrenPaths = Creator.newList();
	}

	public VulnerabilityPath(Expression root, VulnerabilityPath parent) {
		this(root);
		this.parent = parent;
	}

	public Expression getRoot() {
		return root;
	}

	public String getMessage() {
		if (null != message) {
			return message;
		}

		for (VulnerabilityPath vp : childrenPaths) {
			message = vp.getMessage();
			if (null != message) {
				break;
			}
		}

		return message;
	}

	public VulnerabilityPath addNodeToPath(Expression node) {
		VulnerabilityPath nvp = new VulnerabilityPath(node, this);
		childrenPaths.add(nvp);

		return nvp;
	}

	public void foundVulnerability(Expression expr, String message) {
		foundVulnerability();

		System.out.println(message);
		this.message = message;
	}

	/**
	 * This method set the foundVulnerability to true on the parent's path.
	 */
	private void foundVulnerability() {
		foundVulnerability = true;

		if (null != parent) {
			parent.foundVulnerability();
		}

	}

	public void foundInfinitiveLoop(Expression expr) {
		PluginLogger.logIfDebugging("Found an Infinitive Loop at expression: " + expr);
	}

	public void foundInfinitiveLoop(Statement statement) {
		PluginLogger.logIfDebugging("Found an Infinitive Loop at statement: " + statement);
	}

	public boolean isEmpty() {
		if (foundVulnerability) {
			return false;
		}

		if (childrenPaths.isEmpty()) {
			return true;
		}

		for (VulnerabilityPath vp : childrenPaths) {
			if (!vp.isEmpty()) {
				return false;
			}
		}

		return true;
	}

	@Override
	public int hashCode() {
		final int prime = 31;
		int result = 1;
		result = prime * result + getRoot().hashCode();
		return result;
	}

	/**
	 * {@inheritDoc}
	 * 
	 * @param obj
	 *          Object
	 * @return boolean
	 */
	@Override
	public boolean equals(Object obj) {
		if (this == obj) {
			return true;
		}

		if (null == obj) {
			return false;
		}
		if (getClass() != obj.getClass()) {
			return false;
		}

		VulnerabilityPath other = (VulnerabilityPath) obj;
		if (!getRoot().equals(other.getRoot())) {
			return false;
		}

		return true;
	}

}
